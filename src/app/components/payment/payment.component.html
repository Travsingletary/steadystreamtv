<div class="payment-container">
  <!-- Header with Step Indicator -->
  <div class="header">
    <h1>{{ getStepTitle() }}</h1>
    <div class="step-indicator">
      <div class="step" [class.active]="currentStep === 'plan'" [class.completed]="selectedPlan">
        <span>1</span>
        <label>Plan</label>
      </div>
      <div class="step" [class.active]="currentStep === 'method'" [class.completed]="selectedPaymentMethod">
        <span>2</span>
        <label>Method</label>
      </div>
      <div class="step" [class.active]="currentStep === 'details'" [class.completed]="selectedPaymentMethod === 'crypto' || (selectedPaymentMethod === 'card' && customerEmail)">
        <span>3</span>
        <label>Details</label>
      </div>
      <div class="step" [class.active]="currentStep === 'processing'">
        <span>4</span>
        <label>Payment</label>
      </div>
    </div>
  </div>

  <!-- Error Display -->
  <div class="error-message" *ngIf="error">
    <mat-icon>error</mat-icon>
    <span>{{ error }}</span>
  </div>

  <!-- Step 1: Plan Selection -->
  <div class="step-content" *ngIf="currentStep === 'plan'">
    <div class="plans-grid">
      <div
        *ngFor="let plan of subscriptionPlans"
        class="plan-card"
        [class.selected]="selectedPlan?.id === plan.id"
        (click)="selectPlan(plan)"
      >
        <div class="plan-badge" [ngClass]="getPlanBadgeClass(plan)">
          <span *ngIf="plan.id === 'premium_yearly'">üî• BEST VALUE</span>
          <span *ngIf="plan.id === 'premium_monthly'">‚≠ê PREMIUM</span>
          <span *ngIf="plan.id === 'basic_monthly'">üì∫ BASIC</span>
        </div>

        <div class="plan-header">
          <h3>{{ plan.name }}</h3>
          <div class="price">
            <span class="amount">${{ plan.price }}</span>
            <span class="currency">{{ plan.currency }}</span>
          </div>
          <div class="duration" *ngIf="plan.duration === 30">Per Month</div>
          <div class="duration" *ngIf="plan.duration === 365">
            Per Year
            <div class="savings" *ngIf="calculateMonthlySavings(plan) > 0">
              Save ${{ calculateMonthlySavings(plan).toFixed(2) }}/month
            </div>
          </div>
        </div>

        <div class="features">
          <div class="feature" *ngFor="let feature of plan.features">
            <mat-icon>check_circle</mat-icon>
            <span>{{ feature }}</span>
          </div>
        </div>

        <div class="plan-footer">
          <button
            mat-raised-button
            [color]="selectedPlan?.id === plan.id ? 'primary' : 'basic'"
            class="select-button"
          >
            {{ selectedPlan?.id === plan.id ? 'Selected' : 'Select Plan' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Payment Method Selection -->
  <div class="step-content" *ngIf="currentStep === 'method'">
    <div class="selected-plan-summary">
      <h3>Selected Plan: {{ selectedPlan?.name }}</h3>
      <p class="plan-price">${{ selectedPlan?.price }} {{ selectedPlan?.currency }}</p>
    </div>

    <div class="payment-methods">
      <h3>Choose Payment Method</h3>
      <div class="method-grid">
        <div
          *ngFor="let method of paymentMethods"
          class="method-card"
          [class.selected]="selectedPaymentMethod === method.id"
          [class.disabled]="!method.supported"
          (click)="method.supported && selectPaymentMethod(method.id)"
        >
          <div class="method-icon">{{ method.icon }}</div>
          <div class="method-content">
            <h4>{{ method.name }}</h4>
            <p class="method-description">{{ method.description }}</p>
            <div class="method-details">
              <span class="fee">Fee: {{ method.fees }}</span>
              <span class="time">{{ method.processingTime }}</span>
            </div>
          </div>
          <div class="selection-indicator" *ngIf="selectedPaymentMethod === method.id">
            <mat-icon>check_circle</mat-icon>
          </div>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button mat-stroked-button (click)="goBack()">Back</button>
    </div>
  </div>

  <!-- Step 3: Payment Details (for card payments) -->
  <div class="step-content" *ngIf="currentStep === 'details'">
    <div class="selected-plan-summary">
      <h3>{{ selectedPlan?.name }} - {{ getPaymentMethodIcon(selectedPaymentMethod!) }} {{ selectedPaymentMethod === 'crypto' ? 'Cryptocurrency' : 'Credit/Debit Card' }}</h3>
    </div>

    <div class="payment-details" *ngIf="selectedPaymentMethod === 'card'">
      <div class="details-form">
        <h3>Payment Details</h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email Address</mat-label>
          <input matInput type="email" [(ngModel)]="customerEmail" placeholder="your@email.com" required>
          <mat-hint>Required for payment confirmation and account setup</mat-hint>
          <mat-error *ngIf="customerEmail && !isValidEmail(customerEmail)">
            Please enter a valid email address
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Currency</mat-label>
          <mat-select [(ngModel)]="selectedCurrency">
            <mat-option *ngFor="let currency of supportedCurrencies" [value]="currency">
              {{ currency }}
            </mat-option>
          </mat-select>
          <mat-hint>Your card will be charged in this currency</mat-hint>
        </mat-form-field>

        <div class="conversion-info">
          <mat-icon>info</mat-icon>
          <p>{{ getConversionNote() }}</p>
        </div>
      </div>

      <div class="price-breakdown">
        <h4>Price Breakdown</h4>
        <div class="breakdown-item">
          <span>Subscription</span>
          <span>{{ getDisplayPrice() | number:'1.2-2' }} {{ selectedCurrency }}</span>
        </div>
        <div class="breakdown-item">
          <span>Processing Fee ({{ getProcessingFeePercentage() }}%)</span>
          <span>{{ getDisplayProcessingFee() | number:'1.2-2' }} {{ selectedCurrency }}</span>
        </div>
        <div class="breakdown-total">
          <span><strong>Total</strong></span>
          <span><strong>{{ getDisplayTotalPrice() | number:'1.2-2' }} {{ selectedCurrency }}</strong></span>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button mat-stroked-button (click)="goBack()">Back</button>
      <button
        mat-raised-button
        color="primary"
        (click)="processPayment()"
        [disabled]="!canProceedToPayment() || isProcessing"
      >
        {{ selectedPaymentMethod === 'card' ? 'Pay with Card' : 'Pay with Crypto' }}
      </button>
    </div>
  </div>

  <!-- Step 4: Processing -->
  <div class="step-content" *ngIf="currentStep === 'processing'">
    <div class="processing-container">
      <div class="processing-content" *ngIf="isProcessing">
        <mat-spinner></mat-spinner>
        <h3>Processing Payment...</h3>
        <p *ngIf="selectedPaymentMethod === 'crypto'">
          Opening cryptocurrency payment window. Complete your payment and return here.
        </p>
        <p *ngIf="selectedPaymentMethod === 'card'">
          Redirecting to secure payment gateway. Your card will be processed and converted to cryptocurrency.
        </p>
        <div class="processing-steps">
          <div class="step-item">
            <mat-icon>payment</mat-icon>
            <span>Processing {{ selectedPaymentMethod === 'card' ? 'card' : 'crypto' }} payment</span>
          </div>
          <div class="step-item" *ngIf="selectedPaymentMethod === 'card'">
            <mat-icon>swap_horiz</mat-icon>
            <span>Converting to cryptocurrency</span>
          </div>
          <div class="step-item">
            <mat-icon>security</mat-icon>
            <span>Confirming payment</span>
          </div>
          <div class="step-item">
            <mat-icon>tv</mat-icon>
            <span>Activating IPTV service</span>
          </div>
        </div>
      </div>

      <div class="payment-success" *ngIf="!isProcessing && !error">
        <mat-icon class="success-icon">check_circle</mat-icon>
        <h3>Payment Successful!</h3>
        <p>Your IPTV subscription is being activated. You will receive your credentials via email shortly.</p>
        <button mat-raised-button color="primary" routerLink="/subscription">
          Go to Dashboard
        </button>
      </div>
    </div>

    <div class="action-buttons" *ngIf="!isProcessing">
      <button mat-stroked-button (click)="goBack()">Back</button>
    </div>
  </div>
</div>